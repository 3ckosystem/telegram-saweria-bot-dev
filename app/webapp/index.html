<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EnSEXlopedia VIP Catalog</title>

  <!-- Critical CSS mini biar gak "telanjang" -->
  <style>
    :root{
      --bg:#0b0b0b;--text:#fff;--muted:#b7b7b7;--accent:#ff2345;--stroke:#ff234566
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial
    }

    .header{
      position:sticky;top:0;z-index:5;padding:14px 16px 8px;
      background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.45),transparent)
    }
    .brand{font-weight:900;font-size:22px}

    .list{padding:10px 14px 120px}

    .paybar{
      position:fixed;left:0;right:0;bottom:0;z-index:6;display:flex;gap:14px;
      align-items:center;padding:14px 16px 18px;
      background:linear-gradient(0deg,rgba(0,0,0,.85),rgba(0,0,0,.55));
      border-top:1px solid #ffffff14;backdrop-filter:blur(8px)
    }
    .total{flex:1;display:flex;flex-direction:column}
    .total small{color:var(--muted)}
    .badge{
      display:inline-grid;place-items:center;
    }
    .cta{
      appearance:none;border:0;min-width:230px;height:48px;border-radius:22px;
      padding:0 18px;font-weight:800;color:#fff;background:var(--accent)
    }
    .cta:disabled{filter:grayscale(1) opacity(.6)}

    /* —— Clamp deskripsi kartu agar tidak kepanjangan di list —— */
    .desc{
      display:-webkit-box;
      -webkit-line-clamp:3;        /* jumlah baris yang ditampilkan */
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* —— Modal baseline (detail & QR) —— */
    .modal, .qr-modal{
      position:fixed;inset:0;z-index:20;display:grid;place-items:end center;
      background:rgba(0,0,0,.55);backdrop-filter:blur(3px)
    }
    .qr-modal > div{
      margin:16px;padding:16px;border-radius:14px;background:#111;border:1px solid #ffffff1f;
      max-width:min(420px,94vw);color:#fff;text-align:center
    }
    .qr-modal img{width:100%;height:auto;border-radius:10px;border:1px solid #ffffff1a}
    .qr-modal .close{
      margin-top:12px;width:100%;height:44px;border-radius:12px;border:0;
      background:#2b2b2b;color:#fff;font-weight:700
    }

    .modal .sheet{
      width:100%;max-width:720px;background:#0f0f0f;color:#fff;
      border-radius:16px 16px 0 0;border-top:1px solid #ffffff1a;
      padding:14px 16px 16px
    }
    .modal .hero{
      width:100%;height:180px;border-radius:12px;border:1px solid #ffffff1a;
      background:#151515 center/cover no-repeat;margin-bottom:12px
    }
    .modal .title{font-size:20px;font-weight:900;margin-bottom:6px}
    .modal .desc{color:#c6c6c6;white-space:pre-wrap;margin-bottom:12px;display:block;-webkit-line-clamp:unset;-webkit-box-orient:unset;overflow:visible}
    .modal .row{display:flex;gap:10px}
    .modal button{
      flex:1;height:44px;border-radius:12px;border:0;font-weight:800
    }
    .modal .close{background:#2b2b2b;color:#fff}
    .modal .add{background:var(--accent);color:#fff}

    /* —— Gate sheet style agar konsisten dengan tampilan bot —— */
    .gate{
      max-width:520px;margin:24px auto;padding:16px 12px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:#fff;text-align:center
    }
    .gate h3{margin:0 0 8px;font-size:22px}
    .gate p{opacity:.9;margin:0 0 12px}
    .gate .btn{
      display:block;width:100%;padding:12px 14px;margin:8px 0;
      border-radius:12px;border:1px solid #ffffff1a;background:#1b1b1b;
      color:#fff;text-decoration:none;font-weight:800;text-align:center
    }
    .gate .btn:hover{filter:brightness(1.02)}
    .gate .recheck{
      background:linear-gradient(180deg,rgba(255,35,69,.95),rgba(255,35,69,.85));
      border-color:#ff234522
    }
  </style>

  <!-- Styles utama (komponen kartu, tombol, dsb) -->
  <link rel="stylesheet" href="/webapp/styles.css?v=neon7">
</head>
<body>
  <header class="header">
    <div class="brand">VIP Catalog</div>
  </header>

  <!-- daftar kartu -->
  <main id="list" class="list"></main>

  <!-- bar total + checkout -->
  <footer class="paybar">
    <div class="total">
      <small>Total <span id="cartBadge" class="badge">0</span> Group:</small>
      <strong id="total-text" style="font-size:24px">Rp 0</strong>
    </div>
    <button id="pay" class="cta" disabled>Lanjutkan Pembayaran</button>
  </footer>

  <!-- modal QR & Detail -->
  <div id="qr" class="qr-modal" hidden></div>
  <div id="detail" class="modal" hidden></div>

  <!-- ===== Bootstrap UID + Gate Check (load app.js hanya jika lolos) ===== -->
  <script>
    (function boot() {
      // ——— Utility ambil UID dari Telegram WebApp atau dari query ———
      function getUidFromTelegram() {
        try {
          const tg = window.Telegram && window.Telegram.WebApp;
          const u = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
          return u && u.id ? String(u.id) : null;
        } catch (e) { return null; }
      }
      function getUidFromQuery() {
        try {
          const url = new URL(window.location.href);
          const v = url.searchParams.get('uid');
          return v ? String(v) : null;
        } catch (e) { return null; }
      }

      // Prioritas: Telegram initData → ?uid=
      var UID = getUidFromTelegram() || getUidFromQuery();

      // Simpan global agar app.js (dan script lain) bisa akses
      window.__UID__ = UID;

      // Jika tidak ada UID → beri info ramah, jangan crash
      if (!UID) {
        const wrap = document.createElement('div');
        wrap.className = 'gate';
        wrap.innerHTML = `
          <h3>Tidak ada UID Telegram</h3>
          <p>Silakan buka halaman ini dari bot (tombol kiri-bawah) atau gunakan URL dengan parameter <code>?uid=123</code>.</p>
        `;
        document.body.prepend(wrap);
        return; // stop di sini (jangan load app.js)
      }

      // ——— Gate check sebelum load app.js ———
      fetch(`/api/gate/status?uid=${encodeURIComponent(UID)}`, { cache: 'no-store' })
        .then(async (res) => {
          if (res.status === 403) {
            const payload = await res.json().catch(() => ({}));
            showGateBlock(payload.detail || {});
            return null;
          }
          const data = await res.json().catch(() => ({}));
          if (!data || !data.passed) {
            showGateBlock(data || {});
            return null;
          }
          return true;
        })
        .then((ok) => {
          if (!ok) return;
          // Lolos gate → load aplikasi utama
          loadAppJS();
        })
        .catch((err) => {
          const wrap = document.createElement('div');
          wrap.className = 'gate';
          wrap.textContent = 'Gagal memeriksa status. Coba ulang beberapa saat lagi.';
          document.body.prepend(wrap);
        });

      function loadAppJS() {
        // Pastikan Telegram WebApp siap (kalau memang dibuka di Telegram)
        try { window.Telegram && Telegram.WebApp && Telegram.WebApp.ready && Telegram.WebApp.ready(); } catch (e) {}
        // Muat file aplikasi setelah gate pass
        var s = document.createElement('script');
        s.src = '/webapp/app.js?v=neon4';
        s.defer = true;
        document.body.appendChild(s);
      }

      // ===== Gate screen mirip tampilan bot =====
      function showGateBlock(info) {
        // Backend boleh kirim: group_invites[], channel_invites[], group_titles[], channel_titles[], ok_count, total_required
        const gInv = (info && info.group_invites ? info.group_invites : []);
        const cInv = (info && info.channel_invites ? info.channel_invites : []);
        const gTitle = (info && info.group_titles ? info.group_titles : []);
        const cTitle = (info && info.channel_titles ? info.channel_titles : []);

        const buttons = [];

        // Grup
        for (let i = 0; i < gInv.length; i++) {
          const url = gInv[i];
          if (!url) continue;
          const title = (gTitle[i] && String(gTitle[i]).trim()) || 'Group';
          // Label mengikuti gaya bot: "Join <Nama>"
          buttons.push(`<a class="btn" href="${url}" target="_blank" rel="noopener">Join ${escapeHtml(title)}</a>`);
        }
        // Channel
        for (let i = 0; i < cInv.length; i++) {
          const url = cInv[i];
          if (!url) continue;
          const title = (cTitle[i] && String(cTitle[i]).trim()) || 'Channel';
          // Label mengikuti gaya bot: "Subscribe <Nama>"
          buttons.push(`<a class="btn" href="${url}" target="_blank" rel="noopener">Subscribe ${escapeHtml(title)}</a>`);
        }

        const wrap = document.createElement('div');
        wrap.className = 'gate';
        wrap.innerHTML = `
          <h3>Wajib Join/Subscribe Dulu</h3>
          <p>Status: ${(info?.ok_count||0)}/${(info?.total_required||0)} terdeteksi join.</p>
          <div>${buttons.join('')}</div>
          <div style="margin-top:8px">
            <button id="recheckInMiniApp" class="btn recheck">✅ Saya sudah join (Re-check)</button>
          </div>
          <p style="opacity:.85;margin-top:10px">Setelah join, tombol di atas akan menutup Mini App dan kembali ke chat bot untuk verifikasi otomatis.</p>
        `;
        document.body.prepend(wrap);

        // Tombol Re-check: tutup Mini App → user kembali ke chat, lalu tekan "Re-check" (inline) di bot
        const btn = document.getElementById('recheckInMiniApp');
        btn?.addEventListener('click', () => {
          try { Telegram.WebApp.HapticFeedback?.impactOccurred?.('light'); } catch {}
          try { Telegram.WebApp.close(); } catch { window.history.back(); }
        });
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }
    })();
  </script>
</body>
</html>
