<!doctype html>
<html lang="id">
<head>
  <!-- WAJIB: shim resmi Telegram supaya window.Telegram.WebApp tersedia -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EnSEXlopedia VIP Catalog</title>
  <meta name="theme-color" content="#0b0b0b"/>

  <style>
    :root{ --bg:#0b0b0b; --text:#fff; --muted:#b7b7b7; --accent:#ff2345; --stroke:#ff234566 }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text);
          font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial }

    .header{ position:sticky; top:0; z-index:5; padding:14px 16px 8px;
             background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.45),transparent) }
    .brand{ font-weight:900; font-size:22px }
    .hint{ margin:6px 16px 0; font-size:12px; opacity:.7; color:var(--muted) }

    /* ——— App area (disembunyikan sampai gate lolos) ——— */
    #app-root[hidden]{ display:none !important; }
    .list{ padding:10px 14px 120px }

    .paybar{ position:fixed; left:0; right:0; bottom:0; z-index:6; display:flex; gap:14px;
      align-items:center; padding:14px 16px 18px;
      background:linear-gradient(0deg,rgba(0,0,0,.85),rgba(0,0,0,.55));
      border-top:1px solid #ffffff14; backdrop-filter:blur(8px) }
    .total{ flex:1; display:flex; flex-direction:column }
    .total small{ color:var(--muted) }
    .badge{ display:inline-grid; place-items:center; }
    .cta{ appearance:none; border:0; min-width:230px; height:48px; border-radius:22px;
      padding:0 18px; font-weight:800; color:#fff; background:var(--accent) }
    .cta:disabled{ filter:grayscale(1) opacity(.6) }

    .modal, .qr-modal{ position:fixed; inset:0; z-index:20; display:grid; place-items:end center;
      background:rgba(0,0,0,.55); backdrop-filter:blur(3px) }
    .qr-modal > div{ margin:16px; padding:16px; border-radius:14px; background:#111; border:1px solid #ffffff1f;
      max-width:min(420px,94vw); color:#fff; text-align:center }
    .qr-modal img{ width:100%; height:auto; border-radius:10px; border:1px solid #ffffff1a }
    .qr-modal .close{ margin-top:12px; width:100%; height:44px; border-radius:12px; border:0;
      background:#2b2b2b; color:#fff; font-weight:700 }

    /* —— Gate full-screen —— */
    #gate{ position:fixed; inset:0; z-index:30; display:grid; place-items:center;
           background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.7)) }
    #gate[hidden]{ display:none !important; }
    #gate .panel{
      max-width:560px; margin:16px; padding:18px; border-radius:14px; background:#0f0f0f;
      border:1px solid #ffffff22; color:#fff; text-align:center
    }
    #gate a{
      display:block; padding:12px; border-radius:10px; background:#1b1b1b; border:1px solid #ffffff1a;
      color:#fff; text-decoration:none; margin-top:10px
    }
    #gate .row{ display:flex; gap:10px; margin-top:14px }
    #gate .btn{ flex:1; height:44px; border-radius:12px; border:0; font-weight:800 }
    #gate .recheck{ background:var(--accent); color:#fff }
    #gate .closechat{ background:#2b2b2b; color:#fff }
  </style>

  <link rel="stylesheet" href="/webapp/styles.css?v=neon7">
</head>
<body>
  <header class="header">
    <div class="brand">VIP Catalog</div>
    <div id="uid-hint" class="hint" hidden></div>
  </header>

  <!-- === APP ROOT: disembunyikan sampai gate PASSED === -->
  <div id="app-root" hidden>
    <main id="list" class="list"></main>

    <footer class="paybar">
      <div class="total">
        <small>Total <span id="cartBadge" class="badge">0</span> Group:</small>
        <strong id="total-text" style="font-size:24px">Rp 0</strong>
      </div>
      <button id="pay" class="cta" disabled>Lanjutkan Pembayaran</button>
    </footer>

    <div id="qr" class="qr-modal" hidden></div>
    <div id="detail" class="modal" hidden></div>
  </div>

  <!-- === GATE OVERLAY (default tampil sampai lulus) === -->
  <div id="gate">
    <div class="panel" id="gate-panel">
      <h3 style="margin:0 0 8px">Memuat verifikasi…</h3>
      <p style="opacity:.8;margin:0">Harap tunggu sebentar.</p>
    </div>
  </div>

  <!-- ===== Gate-first boot ===== -->
  <script>
    // Username bot kamu (untuk tombol "Buka Chat")
    const BOT_USERNAME = "enSEXlopediaMinibot";

    // ===== Helpers robust: tunggu WebApp siap + dapat UID =====
    function parseUidFromInitDataStr(s){
      if (!s) return null;
      try {
        const usp = new URLSearchParams(s);
        const u = JSON.parse(usp.get('user') || 'null');
        const id = Number(u?.id);
        return Number.isFinite(id) ? id : null;
      } catch { return null; }
    }

    async function waitForWebAppReady(maxMs = 7000) {
      const t0 = Date.now();
      while (Date.now() - t0 < maxMs) {
        const tg = window.Telegram && Telegram.WebApp;
        if (tg) {
          try { tg.ready(); } catch {}
          // tanda WebApp benar-benar diluncurkan
          const signaled = /tgWebAppPlatform=/i.test(location.search);
          const initLen  = (tg.initData || "").length;
          const hasUser  = !!tg.initDataUnsafe?.user?.id;
          if (signaled || initLen > 0 || hasUser) return tg;
        }
        await new Promise(r => setTimeout(r, 120));
      }
      return null;
    }

    async function waitForUID(maxMs = 7000){
      const tg = await waitForWebAppReady(maxMs);
      if (!tg) return null;
      const q = new URLSearchParams(location.search).get('uid');
      return tg.initDataUnsafe?.user?.id
          || parseUidFromInitDataStr(tg.initData)
          || (q ? Number(q) : null);
    }

    // ====== Render helpers (gate overlay) ======
    function setGate(html){
      const p = document.getElementById('gate-panel');
      p.innerHTML = html;
      document.getElementById('gate').hidden = false;
      document.getElementById('app-root').hidden = true;
    }
    function gateLoading(){ setGate(`<h3 style="margin:0 0 8px">Memuat verifikasi…</h3><p style="opacity:.8;margin:0">Harap tunggu sebentar.</p>`); }
    function gateOpenPrivateChat(){
      setGate(`
        <h3 style="margin:0 0 8px">Buka di Chat Pribadi</h3>
        <p style="opacity:.8;margin:0 0 12px">Mini App ini harus dibuka dari DM bot agar UID kamu terbaca.</p>
        <div class="row"><button class="btn recheck" id="btnOpenDM">Buka Chat</button></div>
        <p style="opacity:.7;margin-top:10px">Jika sudah terbuka, tekan <b>Join VIP</b> di menu.</p>
      `);
      document.getElementById('btnOpenDM')?.addEventListener('click', () => {
        try { window.Telegram?.WebApp?.openTelegramLink?.(`https://t.me/${BOT_USERNAME}?start=launch`); } catch {}
      });
    }
    function gateNoUID(){
      setGate(`
        <h3 style="margin:0 0 8px">Tidak ada UID Telegram</h3>
        <p style="opacity:.8;margin:0 0 12px">Buka via bot atau tekan /start lagi, lalu coba lagi.</p>
        <div class="row">
          <button class="btn recheck" id="btnRetry">Coba Lagi</button>
          <button class="btn closechat" id="btnOpenDM2">Buka Chat</button>
        </div>
      `);
      document.getElementById('btnRetry')?.addEventListener('click', boot);
      document.getElementById('btnOpenDM2')?.addEventListener('click', () => {
        try { window.Telegram?.WebApp?.openTelegramLink?.(`https://t.me/${BOT_USERNAME}?start=launch`); } catch {}
      });
    }
    function gateNeedJoin(info){
      const g = (info?.group_invites || []).filter(Boolean);
      const c = (info?.channel_invites || []).filter(Boolean);
      setGate(`
        <h3 style="margin:0 0 8px">Wajib Join/Subscribe Dulu</h3>
        <p style="opacity:.85;margin:0 0 10px">Status: ${(info?.ok_count||0)}/${(info?.total_required||0)} terdeteksi join.</p>
        <div style="margin-top:12px">
          ${g.map(u => `<a href="${u}" target="_blank" rel="noopener">Join Group</a>`).join("")}
          ${c.map(u => `<a href="${u}" target="_blank" rel="noopener">Subscribe Channel</a>`).join("")}
        </div>
        <div class="row" style="margin-top:14px">
          <button class="btn recheck" id="btnRecheck">Re-check</button>
          <button class="btn closechat" id="btnOpenChat">Buka Chat</button>
        </div>
        <p style="opacity:.8;margin-top:8px">Setelah join, kembali ke bot lalu tekan <b>Re-check</b>.</p>
      `);
      document.getElementById('btnRecheck')?.addEventListener('click', boot);
      document.getElementById('btnOpenChat')?.addEventListener('click', ()=> { try{ window.Telegram?.WebApp?.close?.(); }catch{} });
    }
    function gateNetworkError(){
      setGate(`
        <h3 style="margin:0 0 8px">Tidak bisa verifikasi</h3>
        <p style="opacity:.8;margin:0 0 12px">Koneksi bermasalah. Coba lagi beberapa saat.</p>
        <div class="row"><button class="btn recheck" id="btnRetry">Coba Lagi</button></div>
      `);
      document.getElementById('btnRetry')?.addEventListener('click', boot);
    }

    // ====== BOOT ======
    async function boot(){
      gateLoading();

      const tg = window.Telegram?.WebApp;
      try { tg?.ready?.(); tg?.expand?.(); } catch {}

      // If launched dari grup/channel → minta buka DM
      const chatType = tg?.initDataUnsafe?.chat?.type;
      if (chatType && chatType !== "private") return gateOpenPrivateChat();

      // Pastikan UID tersedia
      const uid = await waitForUID(7000);
      if (!uid) return gateNoUID();
      window.__UID__ = uid;

      // Cek gate ke server
      try{
        const res = await fetch(`/api/gate/status?uid=${encodeURIComponent(uid)}`, { cache:'no-store' });
        if (res.status === 403){
          const payload = await res.json();
          return gateNeedJoin(payload.detail);
        }
        const data = await res.json();
        if (!data?.passed) return gateNeedJoin(data);
      }catch(e){
        console.warn("Gate check failed:", e);
        return gateNetworkError();
      }

      // Lulus gate → tampilkan app & load app.js
      document.getElementById('gate').hidden = true;
      document.getElementById('app-root').hidden = false;

      const s = document.createElement('script');
      // ganti versi query biar tembus cache; boleh juga tanpa query
      s.src = '/webapp/app.js?v=neon8';
      s.defer = true;
      s.onerror = () => {
        // tampilkan info kalau file JS nggak ketemu/failed
        const p = document.getElementById('gate-panel');
        p.innerHTML = `
          <h3 style="margin:0 0 8px">Gagal memuat UI</h3>
          <p style="opacity:.8;margin:0 0 12px">File <code>app.js</code> tidak bisa dimuat.</p>
          <div class="row">
            <a class="btn recheck" href="/webapp/app.js">Buka app.js</a>
            <button class="btn closechat" onclick="location.reload()">Muat Ulang</button>
          </div>
        `;
        document.getElementById('gate').hidden = false;
        document.getElementById('app-root').hidden = true;
      };
      document.body.appendChild(s);

    }

    boot();
  </script>
</body>
</html>
